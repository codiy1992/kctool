VERSION 5.00
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.0#0"; "MSCOMCTL.OCX"
Begin VB.Form MainForm 
   BorderStyle     =   1  'Fixed Single
   Caption         =   "ø®≥ÿ÷˙ ÷ -- by CODIY"
   ClientHeight    =   7890
   ClientLeft      =   45
   ClientTop       =   375
   ClientWidth     =   11340
   ForeColor       =   &H80000008&
   Icon            =   "MainForm.frx":0000
   LinkTopic       =   "Form1"
   MaxButton       =   0   'False
   ScaleHeight     =   7890
   ScaleWidth      =   11340
   StartUpPosition =   3  '¥∞ø⁄»± °
   Begin VB.Timer TimerKcCron 
      Enabled         =   0   'False
      Interval        =   3000
      Left            =   2280
      Top             =   8640
   End
   Begin VB.TextBox TextDsp 
      Height          =   3015
      Left            =   3000
      MultiLine       =   -1  'True
      ScrollBars      =   2  'Vertical
      TabIndex        =   8
      Top             =   4800
      Width           =   4340
   End
   Begin VB.TextBox TextLog 
      Height          =   3015
      Left            =   7400
      MultiLine       =   -1  'True
      ScrollBars      =   2  'Vertical
      TabIndex        =   7
      Top             =   4800
      Width           =   3875
   End
   Begin VB.Timer TimerKcTask 
      Enabled         =   0   'False
      Interval        =   300
      Left            =   1800
      Top             =   8640
   End
   Begin VB.Timer TimerKcRead 
      Enabled         =   0   'False
      Interval        =   200
      Left            =   2760
      Top             =   8640
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   15
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   14
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   13
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   12
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   11
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   10
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   9
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   8
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   7
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   6
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   5
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   4
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   3
      Interval        =   3000
      Left            =   4680
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   2
      Interval        =   3000
      Left            =   3240
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   1
      Interval        =   3000
      Left            =   1920
      Top             =   9840
   End
   Begin VB.Timer TimerComCron 
      Enabled         =   0   'False
      Index           =   0
      Interval        =   3000
      Left            =   600
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   15
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   15
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   14
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   14
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   13
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   13
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   12
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   12
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   11
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   11
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   10
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   10
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   9
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   9
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   8
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   8
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   7
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   7
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   6
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   6
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   5
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   5
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   4
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   4
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   3
      Interval        =   300
      Left            =   4320
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   3
      Interval        =   200
      Left            =   5040
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   2
      Interval        =   200
      Left            =   3600
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   0
      Interval        =   200
      Left            =   960
      Top             =   9840
   End
   Begin VB.Timer TimerComRead 
      Enabled         =   0   'False
      Index           =   1
      Interval        =   200
      Left            =   2280
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   2
      Interval        =   300
      Left            =   2880
      Top             =   9840
   End
   Begin VB.Timer TimerInit 
      Enabled         =   0   'False
      Interval        =   100
      Left            =   240
      Top             =   8640
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   1
      Interval        =   300
      Left            =   1560
      Top             =   9840
   End
   Begin VB.Timer TimerComTask 
      Enabled         =   0   'False
      Index           =   0
      Interval        =   300
      Left            =   240
      Top             =   9840
   End
   Begin VB.Frame Frame2 
      Caption         =   "≤Ÿ◊˜∞¥≈•"
      Height          =   3255
      Left            =   120
      TabIndex        =   1
      Top             =   4560
      Width           =   2775
      Begin VB.CommandButton Command1 
         Caption         =   "ªÿœ‘“—ø™"
         Height          =   375
         Left            =   120
         TabIndex        =   17
         Top             =   2280
         Width           =   1215
      End
      Begin VB.CommandButton CommandSwitchIndex 
         Caption         =   "÷∏∂®«–ø®"
         Height          =   375
         Left            =   120
         TabIndex        =   16
         Top             =   840
         Width           =   1215
      End
      Begin VB.CommandButton CommandDspInfo 
         Caption         =   "œ‘ æ–≈œ¢"
         Height          =   375
         Left            =   120
         TabIndex        =   15
         Top             =   1800
         Width           =   1215
      End
      Begin VB.CommandButton CommandGetCCFC 
         Caption         =   "ªÒ»°∫Ù◊™"
         Height          =   375
         Left            =   1440
         TabIndex        =   14
         Top             =   1800
         Width           =   1215
      End
      Begin VB.CommandButton CommandSwitch 
         Caption         =   "◊‘∂Ø«–ø®"
         Height          =   375
         Left            =   120
         TabIndex        =   13
         Top             =   1320
         Width           =   1215
      End
      Begin VB.CommandButton CommandClnTextLog 
         Caption         =   "«Âø’ATº«¬º"
         Height          =   375
         Left            =   1440
         TabIndex        =   12
         Top             =   2760
         Width           =   1215
      End
      Begin VB.CommandButton CommandClnTextDsp 
         Caption         =   "«Âø’ªÿœ‘"
         Height          =   375
         Left            =   120
         TabIndex        =   11
         Top             =   2760
         Width           =   1215
      End
      Begin VB.CommandButton CommandKcSwitch 
         Caption         =   "«–œ¬“ª≈≈"
         Height          =   375
         Left            =   1440
         TabIndex        =   6
         Top             =   840
         Width           =   1215
      End
      Begin VB.CommandButton CommandKcReSet 
         Caption         =   "ø®≥ÿ÷ÿ÷√"
         Height          =   375
         Left            =   1440
         TabIndex        =   5
         Top             =   1320
         Width           =   1215
      End
      Begin VB.CommandButton CommandCloseAll 
         Caption         =   "πÿ±’À˘”–"
         Height          =   375
         Left            =   1440
         TabIndex        =   3
         Top             =   360
         Width           =   1215
      End
      Begin VB.CommandButton CommandStartAll 
         Caption         =   "À—À˜…Ë±∏"
         Height          =   375
         Left            =   120
         TabIndex        =   2
         Top             =   360
         Width           =   1215
      End
   End
   Begin VB.Frame Frame1 
      Caption         =   "¥Æø⁄¡–±Ì"
      Height          =   4335
      Left            =   120
      TabIndex        =   0
      Top             =   120
      Width           =   11150
      Begin MSComctlLib.ListView ListView 
         Height          =   3945
         Left            =   120
         TabIndex        =   4
         Top             =   240
         Width           =   10885
         _ExtentX        =   19209
         _ExtentY        =   6959
         LabelEdit       =   1
         LabelWrap       =   -1  'True
         HideSelection   =   -1  'True
         FullRowSelect   =   -1  'True
         GridLines       =   -1  'True
         _Version        =   393217
         ForeColor       =   -2147483640
         BackColor       =   -2147483637
         BorderStyle     =   1
         Appearance      =   0
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "ÀŒÃÂ"
            Size            =   10.5
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   0
      End
   End
   Begin VB.Label Label1 
      Caption         =   "AT÷∏¡Óº«¬º:"
      Height          =   255
      Left            =   7680
      TabIndex        =   10
      Top             =   4560
      Width           =   2055
   End
   Begin VB.Label Label2 
      Caption         =   " ˝æ›ªÿœ‘¥∞ø⁄:"
      Height          =   255
      Left            =   3120
      TabIndex        =   9
      Top             =   4560
      Width           =   1215
   End
   Begin VB.Menu MenuList 
      Caption         =   "≤Ÿ◊˜"
      Visible         =   0   'False
      Begin VB.Menu MENU_OPEN 
         Caption         =   "ø™∆Ù±æ¥Æø⁄"
      End
      Begin VB.Menu MENU_CLOSE 
         Caption         =   "πÿ±’±æ¥Æø⁄"
         Visible         =   0   'False
      End
      Begin VB.Menu MENU_STOP 
         Caption         =   "‘›Õ£±æ¥Æø⁄"
         Visible         =   0   'False
      End
      Begin VB.Menu MENU_START 
         Caption         =   "ª÷∏¥±æ¥Æø⁄"
         Visible         =   0   'False
      End
      Begin VB.Menu MENU_INFO 
         Caption         =   "≤Èø¥¥Æø⁄–≈œ¢"
      End
      Begin VB.Menu MENU_CCFC 
         Caption         =   "≤È∫Ù◊™∫≈¬Î"
         Visible         =   0   'False
      End
      Begin VB.Menu MENU_DEBUG 
         Caption         =   "≤Èø¥ ˝æ›¡˜"
      End
   End
End
Attribute VB_Name = "MainForm"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
' ≥Ã–Ú“Ï≥£–ﬁ∏¥£¨ ˝æ›ø‚ ˝æ›–ﬁ∏¥

Private Sub Command1_Click()
    If g_blPrint = True Then
        g_blPrint = False
        Command1.Caption = "ªÿœ‘“—πÿ"
    Else
        g_blPrint = True
        Command1.Caption = "ªÿœ‘“—ø™"
    End If
End Sub

'1°¢≥ı ºªØ ±£¨≈–∂œ¥Æø⁄ «ø®≥ÿªπ «simÕ®µ¿
'2°¢«–ø® ±∫Ú–£—È£¨±æ¥Œ«–ø®”Î…œ¥Œ «∑ÒŒ™Õ¨“ª’≈ø®(ø’ø®∫Õ◊Ó∫Û“ª’≈)
'3°¢ø®≥ÿ”ÎsimÕ®µ¿≈‰∂‘–≈œ¢
'4°¢∂‡ø®≥ÿ÷ß≥÷
'5°¢∂‘ø®¿‡–Õµƒ÷ß≥÷
Private Sub Form_Load()
    ' ≥ı ºªØ ˝æ›
    g_iDebugIndex = -1
    g_blPrint = True
    ' ≥ı ºªØ¡–±Ì ”Õºøÿº˛
    With ListView 'ListView≥ı ºªØ
         .View = 3 ' ¡–±Ìœ‘ æ∑Ω Ω
         .ColumnHeaders.Add , , "–Ú∫≈", 600         ' 0
         .ColumnHeaders.Add , , "¥Æø⁄", 800         ' 1
         .ColumnHeaders.Add , , "◊¥Ã¨", 3200        ' 2
         .ColumnHeaders.Add , , "ICCID∫≈", 2300     ' 3
         .ColumnHeaders.Add , , " ÷ª˙∫≈¬Î", 1400    ' 4
         .ColumnHeaders.Add , , "IMEI∫≈", 1800      ' 5
         '.ColumnHeaders.Add , , "–≈∫≈", 1700         ' 6
         .ColumnHeaders.Add , , "’º”√", 800, lvwColumnCenter   ' 7
    End With
End Sub

Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
    Select Case UnloadMode
        Case vbFormControlMenu          ' 0 ”√ªß¥”¥∞ÃÂ…œµƒ°∞øÿº˛°±≤Àµ•÷–—°‘Ò°∞πÿ±’°±÷∏¡Ó°£
        Case vbFormCode                 ' 1 Unload ”Ôæ‰±ª¥˙¬Îµ˜”√°£
        Case vbAppWindows               ' 2 µ±«∞ Microsoft Windows ≤Ÿ◊˜ª∑æ≥ª·ª∞Ω· ¯°£
        Case vbAppTaskManager           ' 3 Microsoft Windows »ŒŒÒπ‹¿Ì∆˜’˝‘⁄πÿ±’”¶”√≥Ã–Ú°£
        Case vbFormMDIForm              ' 4 MDI ◊”¥∞ÃÂ’˝‘⁄πÿ±’£¨“ÚŒ™ MDI ¥∞ÃÂ’˝‘⁄πÿ±’°£
        Case vbFormOwner                ' 5 “ÚŒ™¥∞ÃÂµƒÀ˘”–’ﬂ’˝‘⁄πÿ±’£¨À˘“‘¥∞ÃÂ“≤‘⁄πÿ±’°£
    End Select
    If IsComEmpty = False Then
        If GetAllIccid <> "''" Then
            If MsgBox("«Îœ»πÿ±’»´≤ø¥Æø⁄∫Û‘Ÿ≤Ÿ◊˜", vbYesNo + vbDefaultButton1) = vbYes Then
                For cIdx = 0 To UBound(com())
                    ' Ω´Õ£÷π√¸¡ÓÕ∆ÀÕ»Î√¸¡Ó÷¥––∂”¡–
                    com(cIdx).task.Push ("--CLOSE--")
                    TimerComTask(cIdx).Enabled = True
                Next cIdx
            End If
            Cancel = True
        End If
    End If
End Sub

' ====================================  ≤Ÿ◊˜∞¥≈•  ====================================================
Private Sub CommandStartAll_Click()
    Dim cIdx As Integer
    If IsComEmpty = False Then
        For cIdx = 0 To UBound(com())
            OpenCom (cIdx)
        Next cIdx
        kc.blCanSwitch = True
    ElseIf TimerInit.Enabled = False Then
        ' ºÏ≤‚‘⁄œﬂ¥Æø⁄
        CommandStartAll.Caption = "À—À˜÷–..."
        TimerInit.Enabled = True
    End If
End Sub

Private Sub CommandCloseAll_Click()
    ' πÿ±’¥Æø⁄
    If IsComEmpty = False Then
        For cIdx = 0 To UBound(com())
           ' Ω´Õ£÷π√¸¡ÓÕ∆ÀÕ»Î√¸¡Ó÷¥––∂”¡–
            If com(cIdx).task.Top <> "--CLOSE--" Then
                com(cIdx).task.Push ("--CLOSE--")
                TimerComTask(cIdx).Enabled = True
            End If
        Next cIdx
    End If
End Sub

Private Sub CommandClnTextDsp_Click()
    TextDsp.Text = ""
End Sub

Private Sub CommandClnTextLog_Click()
    TextLog.Text = ""
End Sub

Private Sub CommandDspInfo_Click()
    If IsComEmpty = False Then
        For cIdx = 0 To UBound(com())
            If com(cIdx).blIsOpen = False Then
                TextDsp.Text = TextDsp.Text & "       ±º‰: " & Now() & vbCrLf & _
                           "     COM" & com(cIdx).comPort & ": Œ¥ø™∆Ù" & vbCrLf & _
                           "----- ----- ----- ----- ----- ----- -----" & vbCrLf
            Else
                TextDsp.Text = TextDsp.Text & "       ±º‰: " & Now() & vbCrLf & _
                           "     COM" & com(cIdx).comPort & ": “—ø™∆Ù" & vbCrLf & _
                           "   ÷ª˙∫≈¬Î: " & com(cIdx).Mobile & vbCrLf & _
                           "   ICCID∫≈: " & com(cIdx).Iccid & vbCrLf & _
                           "  IMEI¥Æ∫≈: " & com(cIdx).Imei & vbCrLf & _
                           "  IMSI¥Æ∫≈: " & com(cIdx).Imsi & vbCrLf & _
                           "----- ----- ----- ----- ----- ----- -----" & vbCrLf
            End If
        Next cIdx
    End If
    TextDsp.SelStart = Len(TextDsp.Text)
End Sub

Private Sub CommandGetCCFC_Click()
    If IsComEmpty = False Then
        For cIdx = 0 To UBound(com())
            com(cIdx).task.Push ("AT+CCFC=0,2" & vbCrLf)
            TimerComTask(cIdx).Enabled = True
        Next cIdx
    End If
End Sub

Private Sub CommandKcReSet_Click()
    If IsComEmpty = False Then
        If DB.IsUsing(GetAllIccid) = False Then
            kc.task.Push ("--KC-RESET--")
            TimerKcTask.Enabled = True
        End If
    End If
End Sub

Private Sub CommandKcSwitch_Click()
    If IsComEmpty = False Then
        If DB.IsUsing(GetAllIccid) = False Then
            kc.task.Push ("--KC-NEXT-A--")
            TimerKcTask.Enabled = True
        End If
    End If
End Sub

Private Sub CommandSwitch_Click()
    If IsComEmpty = True Then
        Exit Sub
    End If
    If kc.blCanSwitch = True Then
        kc.blCanSwitch = False
    Else
        kc.blCanSwitch = True
    End If
End Sub

Private Sub CommandSwitchIndex_Click()
    Dim simIndex
    simIndex = InputBox("simø®Œª÷√(1-16)", " ‰»Î«–ªªŒª÷√", 1)
    simIndex = Val(simIndex)
    If IsComEmpty = True Then
        Exit Sub
    End If
    If simIndex < 1 Or simIndex > 16 Then
        MsgBox "«Î ‰»Î1-16÷Æº‰µƒ ˝◊÷"
        Exit Sub
    End If
    If DB.IsUsing(GetAllIccid) = False Then
        kc.task.Push ("--KC-INDEX-A-" & Format(simIndex, "00"))
        TimerKcTask.Enabled = True
    End If
End Sub

Private Sub TimerKcCron_Timer()
    Dim I, j As Integer
    Dim cIdx As Integer
    Dim cntA As Integer, cntB As Integer
    Dim strIccid As String
    Dim execArr
    kc.iTmrCnt = kc.iTmrCnt + 1
    If kc.iTmrCnt Mod 60 = 0 Then
            kc.iTmrCnt = 0
    End If
    
    Frame1.Caption = "ø®≥ÿ - ◊‘∂Ø«–ø®[" & kc.iTmrCnt * 3 & "/180]:" & kc.blCanSwitch & "    (" & Now() & ")"
    If IsComEmpty = True Then
        Exit Sub
    End If
    
    ' ◊‘∂Ø«–ø®»ŒŒÒ
    If kc.blCanSwitch = True Then
        If kc.iTmrCnt = 0 Then
            If DB.IsUsing(GetAllIccid) = False Then
                ' «–ø®
                If InStr(kc.task.Top, "--KC-INDEX-AS-") > 0 Then
                Else
                    kc.task.Push ("--KC-INDEX-AS-" & Format((kc.rowIndex Mod 10) + 1, "00"))
                    TimerKcTask.Enabled = True
                End If
            End If
        End If
    End If
    
    If kc.iTmrCnt Mod 2 = 0 Then
        Exit Sub
    End If
    ' 6√Î÷ÿ÷√≥¨ ±simø® π”√◊¥Ã¨
    DB.setUseTimeOut
    ' ÷¥––«–ø®»ŒŒÒ
    If kc.blIsSwitching = False Then
        execArr = DB.GetSwitchCard(strIccid)
        If execArr <> "" Then
            Dim simIndex As Integer
            simIndex = Val(Mid(execArr, 5, 2))
            If simIndex = kc.rowIndex Then
                DB.SetCardCanUse (strIccid)
            Else
                kc.blIsSwitching = True
                kc.task.Push ("--KC-INDEX-ASU-" & Format(simIndex, "00"))
                TimerKcTask.Enabled = True
            End If
        End If
    End If
    
    ' ÷¥––∞Û∂®ŒﬁÃıº˛∫Ù◊™»ŒŒÒ
    execArr = DB.NotExecBind(GetAllIccid)
    If LCase(TypeName(execArr)) = "string()" Then
        cntA = UBound(execArr) + 1
        For cIdx = 0 To UBound(com())
            For I = 0 To UBound(execArr)
                If execArr(I, 0) = com(cIdx).Iccid Then
                    com(cIdx).iBindId = Val(execArr(I, 1))
                    If execArr(I, 2) <> "" Then
                        com(cIdx).bindMobile (execArr(I, 2))
                    Else
                        com(cIdx).unBindMobile
                    End If
                End If
                TimerComTask(cIdx).Enabled = True
            Next I
        Next cIdx
    End If
    
    ' ÷¥––∑¢ÀÕ∂Ã–≈»ŒŒÒ
    execArr = DB.NotSendedSMS(GetAllIccid(True))
    If LCase(TypeName(execArr)) = "string()" Then
        cntB = UBound(execArr) + 1
        For cIdx = 0 To UBound(com())
            For I = 0 To UBound(execArr)
                If com(cIdx).Iccid = execArr(I, 0) Then
                    com(cIdx).iSmsId = Val(execArr(I, 1))
                    com(cIdx).sendSMS execArr(I, 2), execArr(I, 3)
                    TimerComTask(cIdx).Enabled = True
                End If
            Next I
        Next cIdx
    End If
End Sub
'==============================================  ø®≥ÿøÿ÷∆ƒ£øÈ ==================================================================
Private Sub TimerKcTask_Timer()
    Dim strAT As String
    Dim blCanSwitch As Boolean
    Dim cIdx As Long
    blCanSwitch = True
    
    If kc.blIsATExecing = True Then
        Exit Sub
    End If
    
    strAT = kc.task.Top
    If strAT <> Empty Then
        If kc.blIsOpen = True Then
            Select Case strAT
                Case "--KC-NEXT-A--" ' «–ªªµΩœ¬“ª’≈ø®(»´≤øÕ®µ¿)
                    If IsComEmpty = False Then
                        For cIdx = 0 To UBound(com())
                            If com(cIdx).blIsOpen = True And com(cIdx).blIsNormal = True Then
                                blCanSwitch = False
                                com(cIdx).task.Push ("--CLOSE--")
                                TimerComTask(cIdx).Enabled = True
                            End If
                        Next cIdx
                        If blCanSwitch = False Then
                            Exit Sub
                        End If
                    End If
                    kc.blIsATExecing = True
                    kc.WriteData ("AT+NEXT11" & vbCrLf)
                Case "--KC-NEXT-AS--" ' «–ªªµΩœ¬“ª’≈ø®(»´≤øÕ®µ¿)
                    If IsComEmpty = False Then
                        For cIdx = 0 To UBound(com())
                            If com(cIdx).blIsOpen = True And com(cIdx).blIsNormal = True Then
                                blCanSwitch = False
                                com(cIdx).task.Push ("--CLOSE--")
                                TimerComTask(cIdx).Enabled = True
                            End If
                        Next cIdx
                        If blCanSwitch = False Then
                            Exit Sub
                        End If
                    End If
                    kc.blIsATExecing = True
                    kc.WriteData ("AT+NEXT11" & vbCrLf)
                Case "--KC-RESET--" ' ø®≥ÿ÷ÿ÷√(»´≤øÕ®µ¿)
                    If IsComEmpty = False Then
                        For cIdx = 0 To UBound(com())
                            If com(cIdx).blIsOpen = True And com(cIdx).blIsNormal = True Then
                                blCanSwitch = False
                            End If
                            If com(cIdx).task.Top <> "--CLOSE--" Then
                                com(cIdx).task.Push ("--CLOSE--")
                            End If
                            TimerComTask(cIdx).Enabled = True
                        Next cIdx
                        If blCanSwitch = False Then
                            Exit Sub
                        End If
                    End If
                    kc.blIsATExecing = True
                    kc.WriteData ("AT+NEXT00" & vbCrLf)
                Case Else
                    If InStr(strAT, "--KC-INDEX-A") > 0 Then ' ÷∏∂®«–ªªµΩƒ≥’≈ø®(»´≤øÕ®µ¿)
                        If IsComEmpty = False Then
                            For cIdx = 0 To UBound(com())
                                If com(cIdx).blIsOpen = True And com(cIdx).blIsNormal = True Then
                                    blCanSwitch = False
                                    If com(cIdx).task.Top <> "--CLOSE--" Then
                                        com(cIdx).task.Push ("--CLOSE--")
                                    End If
                                    TimerComTask(cIdx).Enabled = True
                                End If
                            Next cIdx
                            If blCanSwitch = False Then
                                Exit Sub
                            End If
                        End If
                        kc.blIsATExecing = True
                        kc.WriteData ("AT+SWIT00-00" & Right(strAT, 2) & vbCrLf)
                    Else
                        kc.blIsATExecing = True
                        kc.WriteData (strAT)
                    End If
            End Select
        End If
    Else
       TimerKcTask.Enabled = False
    End If
End Sub

Private Sub TimerKcRead_Timer()
    Dim strTmp As String
    Dim strAT As String
    Dim cIdx As Integer
    Dim simIndex As Integer
    
    strTmp = kc.ReadData
    
    If kc.iWaitCnt >= 10 Then
        kc.iWaitCnt = 0
        kc.blIsATExecing = False
    End If
    If strTmp = "" Or kc.blIsATExecing = False Then 'Com(cIdx).blIsATExecing = False Or
        Exit Sub
    End If
    
    strAT = kc.task.Top
    strTmp = kc.GetData(strTmp)
    
    If InStr(strTmp, "OK") > 0 Then
        Select Case strAT
            Case "--KC-NEXT-A--"
                kc.iNullCnt = 0
                If IsComEmpty = False Then
                    For cIdx = 0 To UBound(com())
                        com(cIdx).simIndex = (com(cIdx).simIndex Mod 16) + 1
                    Next cIdx
                    If g_blPrint = True Then
                    TextDsp.Text = TextDsp.Text & "       ±º‰: " & Now() & vbCrLf & _
                           "  ø®≥ÿ«–ø®: ≥…π¶ °æ«–÷¡£∫" & com(0).simIndex & "°ø" & vbCrLf & _
                           "----- ----- ----- ----- ----- ----- -----" & vbCrLf
                    End If
                End If
                
            Case "--KC-NEXT-AS--"
                kc.iNullCnt = 0
                If IsComEmpty = False Then
                    For cIdx = 0 To UBound(com())
                        com(cIdx).simIndex = (com(cIdx).simIndex Mod 16) + 1
                        OpenCom (cIdx)
                    Next cIdx
                    If g_blPrint = True Then
                    TextDsp.Text = TextDsp.Text & "       ±º‰: " & Now() & vbCrLf & _
                           "  ø®≥ÿ«–ø®: ≥…π¶ °æ«–÷¡£∫" & com(0).simIndex & "°ø" & vbCrLf & _
                           "----- ----- ----- ----- ----- ----- -----" & vbCrLf
                    End If
                End If
                
            Case "AT+NEXT11" & vbCrLf ' ø®≥ÿ»´≤ø«–ªª≥…π¶
                kc.iNullCnt = 0
                If IsComEmpty = False Then
                    For cIdx = 0 To UBound(com())
                        com(cIdx).simIndex = (com(cIdx).simIndex Mod 16) + 1
                        OpenCom (cIdx)
                    Next cIdx
                End If
                
            Case "--KC-RESET--"
                kc.iNullCnt = 0
                If IsComEmpty = False Then
                    For cIdx = 0 To UBound(com())
                        com(cIdx).simIndex = 1
                    Next cIdx
                    kc.rowIndex = 1
                    If g_blPrint = True Then
                    TextDsp.Text = TextDsp.Text & "       ±º‰: " & Now() & vbCrLf & _
                           "  ø®≥ÿ÷ÿ÷√: ≥…π¶" & vbCrLf & _
                           "----- ----- ----- ----- ----- ----- -----" & vbCrLf
                    End If
                    TimerKcCron.Enabled = True
                End If
                
            Case "AT+NEXT00" & vbCrLf ' ø®≥ÿ÷ÿ÷√≥…π¶
                kc.iNullCnt = 0
                If IsComEmpty = False Then
                    For cIdx = 0 To UBound(com())
                        com(cIdx).simIndex = 1
                        OpenCom (cIdx)
                    Next cIdx
                    
                End If
                kc.rowIndex = 1
            Case "AT+CWSIM" & vbCr   ' ”Îø®≥ÿŒ’ ÷≥…π¶
                'Kc.task.Push ("AT+NEXT00" & vbCrLf)
                kc.task.Push ("--KC-RESET--")
                TimerKcTask.Enabled = True
                
            Case Else
                If InStr(strAT, "AT+NEXT11-") > 0 Then '"AT+NEXT11-06" & vbCrLf
                    cIdx = Int(Left(Right(strAT, 4), 2)) - 1
                    com(cIdx).simIndex = com(cIdx).simIndex + 1
                    OpenCom (cIdx)
                    
                End If
                
                ' «–ªªµΩ÷∏∂®Œª÷√(»´≤øÕ®µ¿)
                If InStr(strAT, "--KC-INDEX-A-") > 0 Then
                    kc.iNullCnt = 0
                    If IsComEmpty = False Then
                        For cIdx = 0 To UBound(com())
                            com(cIdx).simIndex = Val(Right(strAT, 2))
                        Next cIdx
                    End If
                    kc.rowIndex = Val(Right(strAT, 2))
                    kc.blIsSwitching = False
                    If g_blPrint = True Then
                    TextDsp.Text = TextDsp.Text & "       ±º‰: " & Now() & vbCrLf & _
                           "  ø®≥ÿ«–ø®: ≥…π¶ °æ«–÷¡£∫" & Val(Right(strAT, 2)) & "°ø" & vbCrLf & _
                           "----- ----- ----- ----- ----- ----- -----" & vbCrLf
                    End If
                    
                End If
                ' «–ªªµΩ÷∏∂®Œª÷√(»´≤øÕ®µ¿),
                If InStr(strAT, "--KC-INDEX-AS-") > 0 Then
                    kc.iNullCnt = 0
                    If IsComEmpty = False Then
                        For cIdx = 0 To UBound(com())
                            com(cIdx).simIndex = Val(Right(strAT, 2))
                            OpenCom (cIdx)
                        Next cIdx
                    End If
                    kc.rowIndex = Val(Right(strAT, 2))
                    kc.blIsSwitching = False
                    If g_blPrint = True Then
                    TextDsp.Text = TextDsp.Text & "       ±º‰: " & Now() & vbCrLf & _
                           "  ø®≥ÿ«–ø®: ≥…π¶ °æ«–÷¡£∫" & Val(Right(strAT, 2)) & "°ø" & vbCrLf & _
                           "----- ----- ----- ----- ----- ----- -----" & vbCrLf
                    End If
                End If
                ' «–ªªµΩ÷∏∂®Œª÷√(»´≤øÕ®µ¿)
                If InStr(strAT, "--KC-INDEX-ASU-") > 0 Then
                    kc.iNullCnt = 0
                    If IsComEmpty = False Then
                        For cIdx = 0 To UBound(com())
                            com(cIdx).simIndex = Val(Right(strAT, 2))
                            OpenCom (cIdx)
                        Next cIdx
                    End If
                    kc.rowIndex = Val(Right(strAT, 2))
                    kc.blIsSwitching = False
                    If g_blPrint = True Then
                    TextDsp.Text = TextDsp.Text & "       ±º‰: " & Now() & vbCrLf & _
                           "  ø®≥ÿ«–ø®: ≥…π¶ °æ«–÷¡£∫" & Val(Right(strAT, 2)) & "°ø" & vbCrLf & _
                           "----- ----- ----- ----- ----- ----- -----" & vbCrLf
                    End If
                End If
                
                If InStr(strAT, "AT+SWIT00-") > 0 Then
                    kc.iNullCnt = 0
                    If IsComEmpty = False Then
                        For cIdx = 0 To UBound(com())
                            com(cIdx).simIndex = Val(Left(Right(strAT, 4), 2))
                            OpenCom (cIdx)
                        Next cIdx
                    End If
                End If
                
                ' «–ªªµΩ÷∏∂®Œª÷√(ƒ≥Õ®µ¿)
                If InStr(strAT, "AT+SWIT") > 0 And Mid(strAT, 8, 2) <> "00" Then
                    kc.iNullCnt = 0
                    cIdx = Val(Mid(strAT, 8, 2)) - 1
                    com(cIdx).simIndex = Val(Left(Right(strAT, 4), 2))
                    'OpenCom (cIdx)
                End If
                
        End Select
        strAT = kc.task.Pop
        kc.blIsATExecing = False
    Else
        kc.blIsATExecing = False
    End If
    
End Sub

Private Sub TimerInit_Timer()
    Dim I As Integer
    Dim comport_use() As String
    
    ' ø®≥ÿ
    Set kc = New kc
    kc.index = 1
    kc.comPort = 36
    kc.OpenPort
    If kc.blIsOpen = True Then
        TimerKcTask.Enabled = True
        TimerKcRead.Enabled = True
        kc.task.Push ("AT+CWSIM" & vbCr)
    End If
    
    Call comportScan(36, comport_use())
    If comport_use(0) <> "" Then
        ReDim com(UBound(comport_use()))
        For I = 0 To UBound(comport_use())
            Set LV = ListView.ListItems.Add(I + 1, , I + 1)
            LV.SubItems(1) = "COM" & comport_use(I)
            Set com(I) = New com
            com(I).comPort = comport_use(I)
            com(I).simIndex = 1
            com(I).kc = kc.index
            LV.SubItems(2) = "Œ¥ø™∆Ù"
        Next I
        CommandStartAll.Caption = "ø™∆ÙÀ˘”–"
    Else
        CommandStartAll.Caption = "Œﬁø…”√…Ë±∏"
    End If
    TimerInit.Enabled = False
End Sub

'=========================================================================================================================
Private Sub TimerComCron_Timer(cIdx As Integer)
    
    com(cIdx).iTmrCnt = com(cIdx).iTmrCnt + 1
    If com(cIdx).iTmrCnt Mod 60 = 0 Then
         com(cIdx).iTmrCnt = 0
    End If
    
    If com(cIdx).iTmrCnt Mod 2 = 1 Then
        Dim strTime As String
        If DB.IsUsing("'" & com(cIdx).Iccid & "'", strTime) = True Then
            strTime = 300 - (DateDiff("s", "1970-1-1 8:0:0", DateAdd("s", 0, Now())) - Val(strTime))
            ListView.ListItems(cIdx + 1).SubItems(6) = Format(strTime, "000")
        Else
            ListView.ListItems(cIdx + 1).SubItems(6) = "---"
        End If
    End If
    
    If com(cIdx).blIsShowStat = True Then
        Dim exec As Integer, pick As Integer
        If com(cIdx).blIsATExecing = True Then
            exec = 1
        End If
        If com(cIdx).blIsPickSms = True Then
            pick = 1
        End If
        ListView.ListItems(cIdx + 1).SubItems(2) = "[" & Format(com(cIdx).kc, "000") & "-" & Format(com(cIdx).simIndex, "00") & "-" & Format(cIdx + 1, "00") & "]" & "-" & Format(com(cIdx).task.wIndex, "00") & "-" & Format(com(cIdx).task.rIndex, "00") & "-" & _
                                                        exec & "-" & Format(com(cIdx).iWaitCnt, "00") & "-" & Format(kc.iNullCnt, "00")
    End If
    If com(cIdx).blIsCheck = True And com(cIdx).blIsNormal = True Then
    
        ' »Áπ˚’˝‘⁄∑¢∂Ã–≈ªÚ’ﬂ…Ë÷√∫Ù◊™,‘Ú≤ªÕ˘»ŒŒÒ∂”¡–Õ∆ÀÕ–¬µƒ√¸¡Ó»ŒŒÒ
        If com(cIdx).iSmsId > 0 Or com(cIdx).iBindId > 0 Then
            ListView.ListItems(cIdx + 1).SubItems(2) = "[" & com(cIdx).iSmsId & "|" & com(cIdx).iBindId & "]"
            Exit Sub
        End If
        
        'com(cIdx).task.Push ("AT+CSQ" & vbCrLf)
        
        com(cIdx).task.Push ("AT+CIMI" & vbCrLf)
        
        If com(cIdx).SP = "" Then
            com(cIdx).task.Push ("AT+COPS?" & vbCrLf)
        End If
        
        If com(cIdx).Imei = "" Then
            com(cIdx).task.Push ("AT+CGSN" & vbCrLf)      ' Imei
        End If
        
        'If com(cIdx).Imsi = "" Then
        
        'End If
        
        If com(cIdx).blIsPickSms = True Then
            com(cIdx).task.Push ("AT+CMGL=""ALL""" & vbCrLf)
            com(cIdx).blIsPickSms = False ' √¸¡Ó¥¶¿ÌÕÍ≥…«∞£¨Ω´≤ª‘Ÿ∑¢ÀÕ–¬µƒ»°∂Ã–≈√¸¡Ó
        End If
        
        TimerComTask(cIdx).Enabled = True
    End If
    
    
End Sub

Private Sub TimerComTask_Timer(cIdx As Integer)
    Dim strAT As String
    strAT = com(cIdx).task.Top
    If strAT = Empty Then
        TimerComTask(cIdx).Enabled = False
        Exit Sub
    End If

    If UCase(Left(strAT, 2)) = "AT" And com(cIdx).blIsATExecing = True Then 'Or strAT = "--SWITCH--")
        Exit Sub
    End If
    'If com(cIdx).blIsNormal = True Then
        Select Case strAT
            Case "--TAIL--"
                Dim tail(0) As Byte
                strAT = com(cIdx).task.Pop
                tail(0) = &H1A
                com(cIdx).WriteData (tail)
            Case "--STOP--"
                strAT = com(cIdx).task.Pop
                TimerComTask(cIdx).Enabled = False
                ListView.ListItems(cIdx + 1).SubItems(2) = "“—‘›Õ£"
            Case "--CLOSE--"
                TimerComRead(cIdx).Enabled = True
                If com(cIdx).blIsOpen = True Or com(cIdx).Iccid <> "" Then ' ø™◊≈µƒªÚ’ﬂŒﬁ ÷ª˙∫≈µƒ
                    com(cIdx).blIsCheck = False
                    com(cIdx).WriteData ("AT+CFUN=0" & vbCrLf)
                Else    ' Œﬁsimø®
                     strAT = com(cIdx).task.Pop
                     CloseCom (cIdx)
                End If
            Case "--SWITCH--"
                TimerComRead(cIdx).Enabled = True
                If com(cIdx).blIsOpen = True Or com(cIdx).Iccid <> "" Then ' ø™◊≈µƒªÚ’ﬂŒﬁ ÷ª˙∫≈µƒ
                    com(cIdx).blIsCheck = False
                    com(cIdx).blIsATExecing = True
                    com(cIdx).WriteData ("AT+CFUN=0" & vbCrLf)
                Else    ' Œﬁsimø®
                     strAT = com(cIdx).task.Pop
                     CloseCom (cIdx)
                     kc.task.Push ("AT+NEXT11-" & Format(cIdx + 1, "00") & vbCrLf)
                     TimerKcTask.Enabled = True
                End If
            Case Else
                strAT = com(cIdx).task.Pop
                If UCase(Left(strAT, 2)) = "AT" Then
                    com(cIdx).blIsATExecing = True
                End If
                com(cIdx).WriteData (strAT)
        End Select
    'End If
End Sub


Private Sub TimerComRead_Timer(cIdx As Integer)
    Dim strAtData As String
    Dim tmpBuf() As Byte, strTmp As String
    Dim strOut As String
    Dim strAT As String
    Dim smsArr() As SMSDef
    strTmp = com(cIdx).ReadData
    If com(cIdx).iWaitCnt >= 40 Then
        If com(cIdx).iWaitCnt >= 98 And (com(cIdx).blIsCheck = True Or com(cIdx).blIsPickSms = True) Then
            com(cIdx).iWaitCnt = 0
            com(cIdx).blIsNormal = False
            ListView.ListItems(cIdx + 1).SubItems(2) = "¥Æø⁄ŒﬁœÏ”¶"
        End If
        If com(cIdx).iWaitCnt Mod 40 = 0 Then
            com(cIdx).blIsATExecing = False
        End If
    End If
    If strTmp = "" Then
        Exit Sub
    End If
    If com(cIdx).blIsOpen = True Then
        If cIdx = g_iDebugIndex Then
            TextLog.Text = TextLog.Text & strTmp ' & vbCrLf & "------------------" & vbCrLf
            TextLog.SelStart = Len(TextLog.Text)
        End If
        strAtData = com(cIdx).GetData(strTmp)
        If strAtData = Empty Then
            Exit Sub
        End If
        
        strAT = com(cIdx).AnalysisData(strAtData, strOut)
        
        If strAT = "" Then 'And strAT <> vbCr And strAtData <> vbCrLf And Not IsEmpty(strAT)
            Exit Sub
        End If
        
        com(cIdx).blIsATExecing = False
        Select Case strAT
            Case "AT+CSQ"
                ListView.ListItems(cIdx + 1).SubItems(6) = strOut
            Case "AT+CSCA?"
            Case "AT+COPS?"
                com(cIdx).SP = strOut
                'ListView.ListItems(cIdx + 1).SubItems(6) = strOut
            Case "AT+CGSN"
                com(cIdx).Imei = strOut
                ListView.ListItems(cIdx + 1).SubItems(5) = strOut
            Case "AT+CIMI"
                com(cIdx).Imsi = strOut
            Case "AT+CCFC=0,2"
                If com(cIdx).iQccfcCnt < 10 And strOut = "" Then
                    com(cIdx).task.Push ("AT+CCFC=0,2" & vbCrLf)
                Else
                    ' ≤È ˝æ›ø‚£¨Ã·»° ˝æ›ø‚∞Û∂® ÷ª˙
                    
                    '  ‰≥ˆµΩªÿœ‘¥∞ø⁄
                    If strOut <> "" Then
                        TextDsp.Text = TextDsp.Text & Now() & vbCrLf & _
                                            " ÷ª˙∫≈: " & com(cIdx).Mobile & "(" & com(cIdx).Iccid & ")" & vbCrLf & _
                                            "    …Ë÷√µƒ∫Ù◊™∫≈¬ÎŒ™ °æ" & strOut & "°ø" & vbCrLf & _
                                            "----- ----- ----- ----- ----- ----- -----" & vbCrLf
                    Else
                        TextDsp.Text = TextDsp.Text & Now() & vbCrLf & _
                                        " ÷ª˙∫≈: " & com(cIdx).Mobile & "(" & com(cIdx).Iccid & ")" & vbCrLf & _
                                        "    √ª≤ÈµΩªÚ√ª…Ë÷√∫Ù◊™∫≈¬Î" & vbCrLf & _
                                        "----- ----- ----- ----- ----- ----- -----" & vbCrLf
                    End If
                End If
            Case "-AT-BIND-MOBILE-OK-"
                DB.SetBinded com(cIdx).Iccid, com(cIdx).iBindId
                com(cIdx).iBindId = 0
            Case "-AT-BIND-MOBILE-FAILED-"
                DB.SetNotBind com(cIdx).Iccid, com(cIdx).iBindId
                com(cIdx).iBindId = 0
            Case "-AT-UNBIND-MOBILE-OK-"
                DB.SetBinded com(cIdx).Iccid, com(cIdx).iBindId
                com(cIdx).iBindId = 0
                com(cIdx).bMobile = ""
            Case "-AT-UNBIND-MOBILE-FAILED-"
                DB.SetNotBind com(cIdx).Iccid, com(cIdx).iBindId
                com(cIdx).iBindId = 0
            Case "AT+CMGL"
                If InStr(strOut, "ERROR") Then
                    com(cIdx).task.Push ("AT+CMGF=1" & vbCrLf)    ' …Ë÷√∂Ã–≈∏Ò Ω
                    com(cIdx).task.Push ("AT+CSCS=""UCS2""" & vbCrLf)    ' …Ë÷√∂Ã–≈±‡¬Î
                End If
                strOut = PickAllSMS(strOut, smsArr)
                If UBound(smsArr) > 0 Then
                    For n = 1 To UBound(smsArr)
                         'If cIdx = g_iDebugIndex Then
                         If g_blPrint = True Then
                             TextDsp.Text = TextDsp.Text & vbCrLf & smsArr(n).SmsIndex & vbTab _
                                            & smsArr(n).DateTime & vbTab _
                                            & smsArr(n).SourceNo & vbCrLf _
                                            & smsArr(n).SmsMain & vbCrLf _
                                            & "-------------------------------------" & vbCrLf
                             TextDsp.SelStart = Len(TextDsp.Text)
                         End If
                         'End If
                         If com(cIdx).Iccid <> "" Then
                            DB.SaveSMS com(cIdx).Iccid, smsArr(n).SourceNo, smsArr(n).SmsMain, smsArr(n).DateTime, com(cIdx).Mobile
                            com(cIdx).task.Push ("AT+CMGD=" & smsArr(n).SmsIndex & vbCrLf)
                         End If
                    Next n
                End If
                com(cIdx).blIsPickSms = True    ' ¥¶¿ÌÕÍ≥…∫Û,ºÃ–¯Ω” ‹–¬µƒ»°∂Ã–≈√¸¡Ó
            Case "+CMTI:" '  ’µΩ–¬∂Ã–≈
            Case "-AT-SMS-SEND-OK-" ' ∂Ã–≈∑¢ÀÕ≥…π¶
                DB.SetSMSSended com(cIdx).Iccid, com(cIdx).iSmsId
                com(cIdx).iSmsId = 0
            Case "-AT-SMS-SEND-FAILED-" '∂Ã–≈∑¢ÀÕ ß∞‹
                DB.SetSMSNotSend com(cIdx).Iccid, com(cIdx).iSmsId
                com(cIdx).iSmsId = 0
            Case "-AT-INIT-OK-"    ' ≥ı ºªØ°æ≤Ω÷Ë“ª£∫≥…π¶°ø
                com(cIdx).task.Push ("ATE1" & vbCrLf)         ' ø™∆Ùªÿœ‘
                'com(cIdx).task.Push ("AT+CGSN" & vbCrLf)
                com(cIdx).task.Push ("AT+CGSN" & vbCrLf)
                com(cIdx).task.Push ("AT+CIMI" & vbCrLf)
                com(cIdx).task.Push ("AT+CNMI=2,1" & vbCrLf)  '
                com(cIdx).task.Push ("AT+CSCS=""UCS2""" & vbCrLf)    ' …Ë÷√∂Ã–≈±‡¬Î
                com(cIdx).task.Push ("AT+CCID" & vbCrLf)      ' ≤È—ØICCID∫≈
                ListView.ListItems(cIdx + 1).SubItems(2) = "≥ı ºªØ÷–(1)..."
                ' ø™∆Ù¥Æø⁄√¸¡Ó»ŒŒÒ∂® ±∆˜
                TimerComTask(cIdx).Interval = 100
                TimerComTask(cIdx).Enabled = True
            Case "AT+CCID"         ' ≥ı ºªØ°æ≤Ω÷Ë∂˛£∫≥…π¶°ø
                com(cIdx).blIsNormal = True
                If strOut = "-RETRY-" Then
                    If com(cIdx).iTryCnt = 2 Then
                        TimerComTask(cIdx).Interval = 600
                    End If
                    If com(cIdx).iTryCnt = 3 Then
                        TimerComTask(cIdx).Interval = 900
                    End If
                    If com(cIdx).iTryCnt = 5 Then
                        TimerComTask(cIdx).Interval = 1000
                    End If
                    com(cIdx).task.Push ("AT+CCID" & vbCrLf)      ' ≤È—ØICCID∫≈
                    TimerComTask(cIdx).Enabled = True
                ElseIf strOut = "-NO-CCID-" Then
                    ListView.ListItems(cIdx + 1).SubItems(2) = "¥Æø⁄ŒﬁSIMø®"
                    com(cIdx).Iccid = ""
                    com(cIdx).blIsShowStat = False
                    TimerComRead(cIdx).Enabled = False
                    kc.iNullCnt = kc.iNullCnt + 1
                    If kc.iNullCnt = 16 Then
                        kc.iNullCnt = 0
                        If kc.blCanSwitch = True Then
                            If DB.IsUsing(GetAllIccid) = False Then
                                ' «–ø®
                                If InStr(kc.task.Top, "--KC-INDEX-AS-") > 0 Then
                                Else
                                    kc.task.Push ("--KC-INDEX-AS-" & Format((kc.rowIndex Mod 10) + 1, "00"))
                                    TimerKcTask.Enabled = True
                                End If
                            End If
                        End If
                    End If
                Else
                    com(cIdx).Iccid = Left(strOut, 19)
                    ListView.ListItems(cIdx + 1).SubItems(3) = Left(strOut, 19)
                    ' œÚ ˝æ›ø‚◊¢≤·±æSIMø®£¨≤¢ªÒ»° ÷ª˙∫≈¬Î
                    com(cIdx).Mobile = DB.RegistCard(com(cIdx).Iccid, _
                                                    Format(com(cIdx).kc, "000") & "-" & Format(com(cIdx).simIndex, "00") & "-" & Format(cIdx + 1, "00"), _
                                                    com(cIdx).Imei, com(cIdx).Imsi)
                    If com(cIdx).Mobile = "" Then
                        com(cIdx).blIsShowStat = False
                        ListView.ListItems(cIdx + 1).SubItems(2) = "«Îœ»…Ë÷√ ÷ª˙∫≈"
                        TimerComRead(cIdx).Enabled = False
                    Else
                        ListView.ListItems(cIdx + 1).SubItems(2) = "’˝≥£π§◊˜"
                        ListView.ListItems(cIdx + 1).SubItems(4) = com(cIdx).Mobile
                        com(cIdx).blIsCheck = True
                        'Com(cIdx).blIsSwitch = True
                    End If
                End If
                If strOut <> "-RETRY-" Then
                    com(cIdx).OldIccid = com(cIdx).Iccid
                    TimerComCron(cIdx).Enabled = True
                    TimerComTask(cIdx).Interval = 400
                    TimerComTask(cIdx).Enabled = True
                End If
            Case "-AT-EXIT-OK-"  'πÿ±’sim÷∏¡Ó OK
                 If com(cIdx).task.Top = "--SWITCH--" Then
                    strAT = com(cIdx).task.Pop
                    CloseCom (cIdx)
                    kc.task.Push ("AT+NEXT11-" & Format(cIdx + 1, "00") & vbCrLf)
                    TimerKcTask.Enabled = True
                 Else
                    CloseCom (cIdx)
                 End If
            Case Else
                com(cIdx).blIsATExecing = False
        End Select
    End If
End Sub
Private Sub ListView_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim index As Integer
    '∞¥œ¬ Û±Í”“º¸
    If Button = vbRightButton Then
        If ListView.ListItems.Count > 0 Then
            index = ListView.SelectedItem.index
            If com(index - 1).blIsOpen = True Then
                ' ø™∆Ùπÿ±’≤Àµ•
                MENU_CLOSE.Visible = True
                MENU_CLOSE.Enabled = True
                ' πÿ±’ø™∆Ù≤Àµ•
                MENU_OPEN.Visible = False
                MENU_OPEN.Enabled = False
                
                If MENU_START.Visible = False Then
                    MENU_STOP.Visible = True
                    MENU_STOP.Enabled = True
                End If
                
                MENU_CCFC.Visible = True
                MENU_CCFC.Enabled = True
            Else
                ' ø™∆Ùø™∆Ù≤Àµ•
                MENU_OPEN.Visible = True
                MENU_OPEN.Enabled = True
                ' πÿ±’πÿ±’≤Àµ•
                MENU_CLOSE.Visible = False
                MENU_CLOSE.Enabled = False
                ' πÿ±’‘›Õ£≤Àµ•
                MENU_STOP.Visible = False
                MENU_STOP.Enabled = False
                ' πÿ±’ª÷∏¥≤Àµ•
                MENU_START.Visible = False
                MENU_START.Enabled = False
                
                MENU_CCFC.Visible = False
                MENU_CCFC.Enabled = False
            End If
            PopupMenu MenuList
        End If
    End If
End Sub
Private Sub MENU_OPEN_Click()
    Dim cIdx As Integer
    cIdx = ListView.SelectedItem.index - 1
    OpenCom (cIdx)
End Sub
Private Sub MENU_CLOSE_Click()
    Dim cIdx As Integer
    cIdx = ListView.SelectedItem.index - 1
    ' –ﬁ∏ƒ ˝æ›ø‚◊÷∂Œ◊¥Ã¨
    DB.setCardClose ("'" & com(cIdx).Iccid & "'")
    ' Ω´Õ£÷π√¸¡ÓÕ∆ÀÕ»Î√¸¡Ó÷¥––∂”¡–
    If com(cIdx).task.Top <> "--CLOSE--" Then
        com(cIdx).task.Push ("--CLOSE--")
        TimerComTask(cIdx).Enabled = True
    End If
    com(cIdx).blIsCheck = False
End Sub
Private Sub MENU_STOP_Click()
    Dim cIdx As Integer
    cIdx = ListView.SelectedItem.index - 1
    com(cIdx).task.Push ("--STOP--") ' Ω´Õ£÷π√¸¡ÓÕ∆ÀÕ»Î√¸¡Ó÷¥––∂”¡–
    com(cIdx).blIsCheck = False
    TimerComTask(cIdx).Enabled = True
    TimerComRead(cIdx).Enabled = False
    ' ≤Àµ•
    MENU_START.Visible = True
    MENU_START.Enabled = True
    MENU_STOP.Visible = False
    MENU_STOP.Enabled = False
End Sub
Private Sub MENU_START_Click()
    Dim cIdx As Integer
    cIdx = ListView.SelectedItem.index - 1
    com(cIdx).blIsCheck = True
    TimerComTask(cIdx).Enabled = True
    TimerComRead(cIdx).Enabled = True
    ListView.ListItems(cIdx + 1).SubItems(2) = "’˝≥£π§◊˜"
    ' ≤Àµ•
    MENU_START.Visible = False
    MENU_START.Enabled = False
    MENU_STOP.Visible = True
    MENU_STOP.Enabled = True
End Sub
Private Sub MENU_DEBUG_Click()
    If g_iDebugIndex = ListView.SelectedItem.index - 1 Then
        g_iDebugIndex = -1
        Label1.Caption = "AT÷∏¡Óº«¬º(Œﬁ):"
    Else
        g_iDebugIndex = ListView.SelectedItem.index - 1
        TextLog.Text = ""
        Label1.Caption = "AT÷∏¡Óº«¬º(COM" & com(g_iDebugIndex).comPort & "):"
    End If
End Sub


Private Sub MENU_CCFC_Click()
    Dim cIdx As Integer
    cIdx = ListView.SelectedItem.index - 1
    com(cIdx).task.Push ("AT+CCFC=0,2" & vbCrLf)
    TimerComTask(cIdx).Enabled = True
End Sub

Private Sub MENU_INFO_Click()
    Dim cIdx As Integer
    cIdx = ListView.SelectedItem.index - 1 '"    ∫Ù◊™∫≈¬Î:" com(cidx).bMobile & vbcrlf &
    If com(cIdx).blIsOpen = False Then
        TextDsp.Text = TextDsp.Text & "       ±º‰: " & Now() & vbCrLf & _
                   "     COM" & com(cIdx).comPort & ": Œ¥ø™∆Ù" & vbCrLf & _
                   "----- ----- ----- ----- ----- ----- -----" & vbCrLf
    Else
        TextDsp.Text = TextDsp.Text & "       ±º‰: " & Now() & vbCrLf & _
                   "     COM" & com(cIdx).comPort & ": “—ø™∆Ù" & vbCrLf & _
                   "   ÷ª˙∫≈¬Î: " & com(cIdx).Mobile & vbCrLf & _
                   "   ICCID∫≈: " & com(cIdx).Iccid & vbCrLf & _
                   "  IMEI¥Æ∫≈: " & com(cIdx).Imei & vbCrLf & _
                   "  IMSI¥Æ∫≈: " & com(cIdx).Imsi & vbCrLf & _
                   "----- ----- ----- ----- ----- ----- -----" & vbCrLf
    End If
    TextDsp.SelStart = Len(TextDsp.Text)
End Sub


'**********************************************************************
' ¥Æø⁄…®√Ë
'**********************************************************************
Function comportScan(kc As Integer, comPort() As String)
    Dim I As Integer
    Dim ret As Long
    ReDim Preserve comPort(0)
    Dim com() As Integer
    com() = DB.GetComByKc(kc)
    For I = 0 To UBound(com())
        ret = sio_open(com(I))
        If ret = SIO_OK Then
            sio_close (com(I))
            comPort(UBound(comPort())) = com(I)
            ReDim Preserve comPort(UBound(comPort()) + 1)
        End If
    Next I
    ReDim Preserve comPort(UBound(comPort()) - 1)
End Function


Public Function OpenCom(ByRef cIdx As Integer)
    If com(cIdx).blIsOpen = False Then
        com(cIdx).OpenPort
        If com(cIdx).blIsOpen = False Then
            ListView.ListItems(cIdx + 1).SubItems(2) = ComErr(com(cIdx).portErr)
        Else
            ListView.ListItems(cIdx + 1).SubItems(2) = "≥ı ºªØ÷–(0)..."
            com(cIdx).task.Clean
            com(cIdx).task.Push ("ATE1" & vbCrLf)
            com(cIdx).task.Push ("AT+CFUN=1,1" & vbCrLf)
            ' ø™∆Ù¥Æø⁄√¸¡Ó»ŒŒÒ∂® ±∆˜
            TimerComTask(cIdx).Enabled = True
            TimerComRead(cIdx).Enabled = True
        End If
    End If
End Function

Public Function CloseCom(ByRef cIdx As Integer)
    TimerComRead(cIdx).Enabled = False
    TimerComTask(cIdx).Enabled = False
    com(cIdx).blIsCheck = False
    TimerComCron(cIdx).Enabled = False
    ListView.ListItems(cIdx + 1).SubItems(3) = ""
    ListView.ListItems(cIdx + 1).SubItems(4) = ""
    ListView.ListItems(cIdx + 1).SubItems(5) = ""
    ListView.ListItems(cIdx + 1).SubItems(6) = ""
    'ListView.ListItems(cIdx + 1).SubItems(6) = ""
    DB.setCardClose ("'" & com(cIdx).Iccid & "'")
    com(cIdx).ReSet
    ListView.ListItems(cIdx + 1).SubItems(2) = "Œ¥ø™∆Ù"
End Function
